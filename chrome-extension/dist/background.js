(()=>{"use strict";const e=new class{constructor(){this.token=null}setToken(e){this.token=e}async fetchWithAuth(e,t={}){if(!this.token)throw new Error("Not authenticated");const s=await fetch(`https://replyguy.appendment.com/api${e}`,{...t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`,...t.headers}});if(!s.ok){const e=await s.json().catch(()=>({error:"Request failed"}));throw new Error(e.error||`HTTP ${s.status}`)}return s.json()}async generateReply(e){return this.fetchWithAuth("/generate",{method:"POST",body:JSON.stringify(e)})}async getSuggestions(e){return this.fetchWithAuth("/suggest",{method:"POST",body:JSON.stringify({tweet:e})})}async generateMeme(e,t){return this.fetchWithAuth("/meme",{method:"POST",body:JSON.stringify({text:e,context:t})})}async getUsageLimits(){const[e,t]=await Promise.all([this.fetchWithAuth("/check-limits"),this.fetchWithAuth("/user/plan")]);return{repliesRemaining:e.repliesRemaining,repliesTotal:t.limits.replies,suggestionsRemaining:e.suggestionsRemaining,suggestionsTotal:t.limits.suggestions,memesRemaining:e.memesRemaining,memesTotal:t.limits.memes}}async getCurrentUser(){return this.fetchWithAuth("/auth/session")}},t=new class{constructor(){this.authState={isAuthenticated:!1}}async checkSupabaseSession(){try{console.log("[Auth] Checking Supabase session...");const t=await chrome.cookies.getAll({domain:".appendment.com"});console.log("[Auth] Found cookies:",t.map(e=>({name:e.name,domain:e.domain,path:e.path,secure:e.secure,httpOnly:e.httpOnly,sameSite:e.sameSite})));const s="sb-aaplsgskmoeyvvedjzxp-auth-token",a=t.filter(e=>e.name===s||e.name.startsWith(`${s}.`)).sort((e,t)=>e.name.localeCompare(t.name));if(console.log("[Auth] Auth token parts found:",a.length),0===a.length)return console.log("[Auth] No auth token found"),{isAuthenticated:!1};let n="";n=1===a.length?a[0].value:a.map(e=>e.value).join(""),console.log("[Auth] Token reconstructed, length:",n.length);try{const s=await fetch("https://replyguy.appendment.com/api/auth/extension",{method:"GET",credentials:"include",headers:{Cookie:t.map(e=>`${e.name}=${e.value}`).join("; ")}});if(console.log("[Auth] Session check response status:",s.status),s.ok){const t=await s.json();if(console.log("[Auth] Session data:",t),t.authenticated&&t.user)return this.authState={isAuthenticated:!0,user:{id:t.user.id,email:t.user.email},token:n},e.setToken(n),console.log("[Auth] Authentication successful"),this.authState}}catch(e){console.error("[Auth] Session check error:",e)}return console.log("[Auth] Authentication failed"),{isAuthenticated:!1}}catch(e){return console.error("[Auth] Auth check failed:",e),{isAuthenticated:!1}}}async waitForLogin(){return chrome.tabs.create({url:"https://replyguy.appendment.com/auth/login?extension=true"}),new Promise(e=>{const t=setInterval(async()=>{const s=await this.checkSupabaseSession();s.isAuthenticated&&(clearInterval(t),e(s))},2e3);setTimeout(()=>{clearInterval(t),e({isAuthenticated:!1})},3e5)})}getAuthState(){return this.authState}async logout(){this.authState={isAuthenticated:!1};const e=await chrome.cookies.getAll({domain:".appendment.com"});for(const t of e)t.name.startsWith("sb-")&&await chrome.cookies.remove({url:`https://${t.domain}${t.path}`,name:t.name})}};chrome.runtime.onInstalled.addListener(async()=>{await t.checkSupabaseSession()}),chrome.runtime.onMessage.addListener((s,a,n)=>((async()=>{try{switch(s.action){case"checkAuth":const a=await t.checkSupabaseSession();n({success:!0,data:a});break;case"generateReply":const o=await e.generateReply(s.data);n({success:!0,data:o});break;case"getSuggestions":const i=await e.getSuggestions(s.data.tweet);n({success:!0,data:i});break;case"generateMeme":const c=await e.generateMeme(s.data.text,s.data.context);n({success:!0,data:c});break;case"getUsageLimits":const r=await e.getUsageLimits();n({success:!0,data:r});break;case"openLogin":chrome.tabs.create({url:"https://replyguy.appendment.com/auth/login?extension=true"}),n({success:!0});break;default:n({success:!1,error:"Unknown action"})}}catch(e){console.error("Background script error:",e),n({success:!1,error:e instanceof Error?e.message:"Unknown error"})}})(),!0)),chrome.cookies.onChanged.addListener(async e=>{e.cookie.domain.includes("appendment.com")&&e.cookie.name.startsWith("sb-")&&(await t.checkSupabaseSession(),(await chrome.tabs.query({})).forEach(e=>{e.id&&chrome.tabs.sendMessage(e.id,{action:"authStateChanged",data:t.getAuthState()}).catch(()=>{})}))})})();