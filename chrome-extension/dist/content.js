(()=>{"use strict";class e{constructor(e){this.overlay=null,this.responseType="neutral",this.tone="friendly",this.responseIdea="",this.replyLength="short",this.needsResearch=!1,this.perplexityGuidance="",this.includeMeme=!1,this.memeText="",this.currentReplyData=null,this.originalTweet="",this.memeTextMode="exact",this.tweet="",this.userPlan=null,this.usageLimits=null,this.isSuggestingIdea=!1,this.isSuggestingResearch=!1,this.researchSuggestions=[],this.useCustomStyle=!1,this.enableStyleMatching=!1,this.defaultSettings={},this.handleOutsideClick=e=>{const n=e.target,t=n.closest('[data-testid="reply"]')||n.closest('[role="group"]');!this.overlay||this.overlay.contains(n)||t||this.remove()},this.container=e}async saveUserSettings(){if(chrome?.storage?.sync)try{await chrome.storage.sync.set({replyGuySettings:{responseType:this.responseType,tone:this.tone,replyLength:this.replyLength,needsResearch:this.needsResearch,includeMemes:this.includeMeme,useCustomStyle:this.useCustomStyle}}),console.log("[ReplyGuy] Saved user settings")}catch(e){console.error("[ReplyGuy] Failed to save settings:",e)}}async loadUserSettings(){if(chrome?.storage?.sync)try{const e=await chrome.storage.sync.get(["replyGuySettings"]);if(e.replyGuySettings){const n=e.replyGuySettings;this.responseType=n.responseType||this.responseType,this.tone=n.tone||this.tone,this.replyLength=n.replyLength||this.replyLength,this.needsResearch=n.needsResearch??this.needsResearch,this.includeMeme=n.includeMemes??this.includeMeme,this.useCustomStyle=n.useCustomStyle??this.useCustomStyle,console.log("[ReplyGuy] Loaded user settings:",n)}}catch(e){console.error("[ReplyGuy] Failed to load settings:",e)}}async showOptions(e,n){this.remove(),this.tweet=e,this.originalTweet=e,await this.loadUserSettings();try{if(!chrome.runtime?.id)return void console.error("[ReplyGuy] Extension context invalid");const e=await chrome.runtime.sendMessage({action:"getUsageLimits"});e.success&&e.data&&(this.usageLimits=e.data,this.userPlan=e.data.userPlan||e.data,console.log("[ReplyGuy] User plan loaded:",this.userPlan),console.log("[ReplyGuy] Usage limits:",this.usageLimits))}catch(e){if(e instanceof Error&&e.message.includes("Extension context invalidated"))return console.error("[ReplyGuy] Extension context invalidated"),alert("Reply Guy extension needs to be refreshed. Please reload this page."),void this.remove();console.error("[ReplyGuy] Failed to get user plan:",e)}this.overlay=document.createElement("div"),this.overlay.className="reply-guy-overlay",this.overlay.innerHTML=`\n      <style>\n        ${this.getComprehensiveStyles()}\n      </style>\n      <div class="reply-guy-header">\n        <div class="reply-guy-title">\n          <img src="${chrome.runtime.getURL("icons/reply_guy_logo.png")}" class="reply-guy-logo-icon" alt="Reply Guy" />\n          <span>Reply Guy</span>\n        </div>\n        <button class="reply-guy-close" aria-label="Close">√ó</button>\n      </div>\n      \n      <div class="reply-guy-content">\n        \x3c!-- Tweet Preview --\x3e\n        <details class="reply-guy-tweet-section" open>\n          <summary>Replying to...</summary>\n          <div class="reply-guy-tweet-preview">\n            ${this.escapeHtml(e)}\n          </div>\n        </details>\n        \n        \x3c!-- Main Options --\x3e\n        <div class="reply-guy-main-section">\n          <div class="reply-guy-row">\n            \x3c!-- Response Type --\x3e\n            <div class="reply-guy-option-group reply-guy-half">\n              <label class="reply-guy-option-label" for="reply-guy-response-type">Response Type</label>\n              <select class="reply-guy-select" id="reply-guy-response-type">\n                <option value="agree">üëç Agree</option>\n                <option value="disagree">ü§î Disagree</option>\n                <option value="neutral" selected>üí≠ Neutral</option>\n                <option value="other">‚ú® Creative</option>\n              </select>\n            </div>\n            \n            \x3c!-- Tone --\x3e\n            <div class="reply-guy-option-group reply-guy-half">\n              <label class="reply-guy-option-label" for="reply-guy-tone">Tone</label>\n              <select class="reply-guy-select" id="reply-guy-tone">\n                <option value="friendly">üòä Friendly</option>\n                <option value="professional">üíº Professional</option>\n                <option value="casual">üëã Casual</option>\n                <option value="humorous">üòÑ Humorous</option>\n                <option value="empathetic">‚ù§Ô∏è Empathetic</option>\n                <option value="witty">üéØ Witty</option>\n                <option value="sarcastic">üòè Sarcastic</option>\n                <option value="supportive">ü§ù Supportive</option>\n                <option value="informative">üìö Informative</option>\n                <option value="formal">üé© Formal</option>\n              </select>\n            </div>\n          </div>\n          \n          \x3c!-- Response Idea --\x3e\n          <div class="reply-guy-option-group">\n            <div class="reply-guy-label-with-action">\n              <label class="reply-guy-option-label" for="reply-guy-idea">What do you want to say?</label>\n              <button class="reply-guy-suggest-btn" id="reply-guy-suggest">\n                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">\n                  <path d="M12 2L13.09 8.26L19 7L15.45 11.82L21 16L14.5 16.5L15 23L10.18 17.45L5 21L5.5 14.5L0 16L5.55 11.18L2 7L7.91 8.26L9 2L12 2Z" fill="currentColor"/>\n                </svg>\n                Suggest\n              </button>\n            </div>\n            <textarea \n              id="reply-guy-idea" \n              class="reply-guy-idea-input" \n              placeholder="Describe your response (e.g., 'Sympathize and share a similar experience')"\n              rows="3"\n              maxlength="${this.userPlan?.max_response_idea_length||200}"\n            >${this.responseIdea}</textarea>\n            <div class="reply-guy-char-count">\n              <span id="idea-char-count">0</span> / <span id="idea-char-limit">${this.userPlan?.max_response_idea_length||200}</span>\n            </div>\n          \n          \x3c!-- Reply Length --\x3e\n          <div class="reply-guy-option-group">\n            <label class="reply-guy-option-label">Reply Length</label>\n            <div class="reply-guy-length-options">\n              <label class="reply-guy-radio">\n                <input type="radio" name="replyLength" value="short" checked>\n                <span>Short (280)</span>\n              </label>\n              <label class="reply-guy-radio">\n                <input type="radio" name="replyLength" value="medium" ${this.userPlan?.enable_long_replies?"":"disabled"}>\n                <span>Medium (560) ${this.userPlan?.enable_long_replies?"":"üîí"}</span>\n              </label>\n              <label class="reply-guy-radio">\n                <input type="radio" name="replyLength" value="long" ${this.userPlan?.enable_long_replies?"":"disabled"}>\n                <span>Long (1000) ${this.userPlan?.enable_long_replies?"":"üîí"}</span>\n              </label>\n              <label class="reply-guy-radio">\n                <input type="radio" name="replyLength" value="extra-long" ${!this.userPlan?.enable_long_replies||this.userPlan?.max_reply_length<2e3?"disabled":""}>\n                <span>Extra Long (2000) ${!this.userPlan?.enable_long_replies||this.userPlan?.max_reply_length<2e3?"üîí":""}</span>\n              </label>\n            </div>\n          </div>\n        </div>\n        \n        \x3c!-- Advanced Options --\x3e\n        <details class="reply-guy-advanced-section">\n          <summary>Advanced Options</summary>\n          <div class="reply-guy-advanced-content">\n            \n            \x3c!-- Perplexity Research --\x3e\n            ${!1!==this.userPlan?.enable_perplexity_guidance?'\n            <div class="reply-guy-option-group">\n              <label class="reply-guy-checkbox">\n                <input type="checkbox" id="reply-guy-research">\n                <span>Use real-time research üîç</span>\n              </label>\n              <div id="reply-guy-research-section" style="display: none; margin-top: 12px;">\n                <div class="reply-guy-label-with-action">\n                  <label class="reply-guy-option-label" for="reply-guy-perplexity" style="margin-bottom: 4px;">\n                    Research Guidance (Optional)\n                  </label>\n                  <button class="reply-guy-suggest-btn" id="reply-guy-suggest-research" type="button">\n                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none">\n                      <path d="M12 2L13.09 8.26L19 7L15.45 11.82L21 16L14.5 16.5L15 23L10.18 17.45L5 21L5.5 14.5L0 16L5.55 11.18L2 7L7.91 8.26L9 2L12 2Z" fill="currentColor"/>\n                    </svg>\n                    Suggest\n                  </button>\n                </div>\n                <textarea\n                  id="reply-guy-perplexity" \n                  class="reply-guy-text-input" \n                  placeholder="What specific facts, stats, or current events should we look for?"\n                  rows="2"\n                  maxlength="200"\n                ></textarea>\n                <div id="reply-guy-research-suggestions" style="display: none; margin-top: 8px;">\n                  <p class="reply-guy-suggestion-label">Suggestions:</p>\n                  <div class="reply-guy-suggestion-chips"></div>\n                </div>\n              </div>\n            </div>\n            ':""}\n            \n            \n            ${!1!==this.userPlan?.enable_write_like_me?'\n            <div class="reply-guy-option-group">\n              <label class="reply-guy-checkbox">\n                <input type="checkbox" id="reply-guy-write-like-me">\n                <span>Write like me ‚úçÔ∏è</span>\n              </label>\n              <p class="reply-guy-option-hint">Use your personal writing style</p>\n            </div>\n            ':""}\n            \n            \n            ${!1!==this.userPlan?.enable_style_matching?'\n            <div class="reply-guy-option-group">\n              <label class="reply-guy-checkbox">\n                <input type="checkbox" id="reply-guy-match-style">\n                <span>Match tweet style üé®</span>\n              </label>\n              <p class="reply-guy-option-hint">Adapt to the original tweet\'s tone and style</p>\n            </div>\n            ':""}\n          </div>\n        </details>\n        \n        \x3c!-- Fun Extras --\x3e\n        ${!1!==this.userPlan?.enable_memes?`\n        <details class="reply-guy-extras-section">\n          <summary>Fun Extras</summary>\n          <div class="reply-guy-extras-content">\n            <div class="reply-guy-option-group">\n              <label class="reply-guy-checkbox">\n                <input type="checkbox" id="reply-guy-meme">\n                <span>Add a meme üé≠</span>\n                <span class="reply-guy-meme-usage">${this.userPlan?.memes_used||0}/${this.userPlan?.meme_limit||0} used</span>\n              </label>\n              <div id="reply-guy-meme-options" style="display: none; margin-top: 12px;">\n                <div class="reply-guy-option-group">\n                  <label class="reply-guy-option-label" style="font-size: 11px;">Meme text (optional)</label>\n                  <input \n                    type="text"\n                    id="reply-guy-meme-text" \n                    class="reply-guy-text-input" \n                    placeholder="e.g., 'this is fine' or 'bugs everywhere'"\n                    maxlength="100"\n                  />\n                </div>\n                \n                \x3c!-- Show mode selector only when user has typed text --\x3e\n                <div id="reply-guy-meme-mode-section" style="display: none; margin-top: 12px;">\n                  <div class="reply-guy-meme-mode">\n                    <label class="reply-guy-radio">\n                      <input type="radio" name="memeTextMode" value="exact" checked>\n                      <span>Use my exact text</span>\n                    </label>\n                    <label class="reply-guy-radio">\n                      <input type="radio" name="memeTextMode" value="enhance">\n                      <span>Make it more creative with AI ‚ú®</span>\n                    </label>\n                  </div>\n                </div>\n                \n                <div class="reply-guy-meme-info">\n                  <p id="meme-info-empty">üí° <strong>Leave blank</strong> = AI creates meme text from your reply</p>\n                  <p id="meme-info-exact" style="display: none;">‚úèÔ∏è Your exact text will be used: "<span id="meme-preview-text"></span>"</p>\n                  <p id="meme-info-enhance" style="display: none;">‚ú® AI will enhance your idea to make it funnier</p>\n                </div>\n              </div>\n            </div>\n          </div>\n        </details>\n        `:""}\n        \n        \x3c!-- Save Defaults --\x3e\n        <div class="reply-guy-save-defaults">\n          <label class="reply-guy-checkbox">\n            <input type="checkbox" id="reply-guy-save-defaults">\n            <span>Save as default settings</span>\n          </label>\n        </div>\n        \n        \x3c!-- Action Buttons --\x3e\n        <div class="reply-guy-actions">\n          <button class="reply-guy-generate-btn" id="reply-guy-generate">\n            Generate Reply\n          </button>\n          ${this.usageLimits?`\n          <div class="reply-guy-usage">\n            <span class="reply-guy-usage-used">${(this.usageLimits.repliesTotal||0)-(this.usageLimits.repliesRemaining||0)}</span> / ${this.usageLimits.repliesTotal||0} replies\n            <span class="reply-guy-usage-detail">(${this.usageLimits.repliesRemaining||0} remaining this billing period)</span>\n          </div>\n          ${void 0!==this.usageLimits.dailyCount?`\n          <div class="reply-guy-daily-goal">\n            <span class="reply-guy-daily-icon">üéØ</span>\n            <span class="reply-guy-daily-text">Daily Goal: ${this.usageLimits.dailyCount||0} / ${this.usageLimits.dailyGoal||10}</span>\n          </div>\n          `:""}\n          `:""}\n        </div>\n      </div>\n    `;const t=this.container.getBoundingClientRect();this.overlay.style.position="fixed";const o=.8*window.innerHeight;window.innerHeight-t.bottom-16<o&&t.top>o?(this.overlay.style.bottom=window.innerHeight-t.top+8+"px",this.overlay.style.top="auto"):this.overlay.style.top=`${Math.min(t.bottom+8,window.innerHeight-o)}px`,this.overlay.style.left=`${Math.min(t.left,window.innerWidth-500)}px`,this.overlay.style.width="480px",this.attachEventListeners(n),setTimeout(()=>{document.addEventListener("click",this.handleOutsideClick)},0),document.body.appendChild(this.overlay)}attachEventListeners(e){if(!this.overlay)return;this.overlay.querySelector(".reply-guy-close")?.addEventListener("click",()=>this.remove());const n=this.overlay.querySelector("#reply-guy-response-type");n&&(n.value=this.responseType,n.addEventListener("change",()=>{this.responseType=n.value}));const t=this.overlay.querySelector("#reply-guy-tone");t&&(t.value=this.tone,t.addEventListener("change",()=>{this.tone=t.value}));const o=this.overlay.querySelector("#reply-guy-idea"),i=this.overlay.querySelector("#idea-char-count");if(this.overlay.querySelector("#idea-char-limit"),o&&i){const e=this.userPlan?.max_response_idea_length||200,n=()=>{const n=o.value.length;i.textContent=n.toString(),o.classList.toggle("error",n>e)};o.addEventListener("input",()=>{this.responseIdea=o.value,n()}),n()}this.overlay.querySelector("#reply-guy-suggest")?.addEventListener("click",async e=>{if(e.preventDefault(),e.stopPropagation(),console.log("[ReplyGuy] Suggest button clicked"),!this.tweet.trim())return void alert("Please wait for tweet to load");const n=this.overlay?.querySelector("#reply-guy-suggest");if(!n||n.disabled)return;n.disabled=!0;const t=n.innerHTML;n.innerHTML='<svg class="reply-guy-spinner-small" width="14" height="14" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10"></circle></svg> Suggesting...';try{if(!chrome.runtime?.id)throw new Error("Extension context invalidated");const e=await chrome.runtime.sendMessage({action:"getSuggestions",data:{tweet:this.tweet,responseType:this.responseType,tone:this.tone}});if(e&&e.success&&e.data?.suggestion)this.responseIdea=e.data.suggestion,o&&(o.value=this.responseIdea,o.dispatchEvent(new Event("input")));else{const n=e?.error||"Failed to get suggestion";console.error("[ReplyGuy] Failed to get suggestion:",n),n.includes("limit")?alert("You have reached your suggestion limit. Please upgrade your plan."):alert("Failed to generate suggestion. Please try again.")}}catch(e){console.error("[ReplyGuy] Suggest error:",e),e instanceof Error&&e.message.includes("Extension context invalidated")?alert("Reply Guy extension needs to be refreshed. Please reload this page."):alert("An error occurred. Please try again.")}finally{n&&this.overlay&&(n.disabled=!1,n.innerHTML=t)}}),this.overlay.querySelectorAll('input[name="replyLength"]').forEach(e=>{const n=e;n.value===this.replyLength&&(n.checked=!0),n.addEventListener("change",e=>{this.replyLength=e.target.value})});const r=this.overlay.querySelector("#reply-guy-research"),s=this.overlay.querySelector("#reply-guy-research-section"),a=this.overlay.querySelector("#reply-guy-perplexity");r&&(r.checked=this.needsResearch,s&&(s.style.display=this.needsResearch?"block":"none"),r.addEventListener("change",()=>{this.needsResearch=r.checked,s&&(s.style.display=this.needsResearch?"block":"none")})),a?.addEventListener("input",()=>{this.perplexityGuidance=a.value}),this.overlay.querySelector("#reply-guy-suggest-research")?.addEventListener("click",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.tweet.trim()||!this.responseIdea.trim())return void alert("Please enter a tweet and response idea first");const n=this.overlay?.querySelector("#reply-guy-suggest-research");n&&(n.disabled=!0,n.innerHTML='<svg class="reply-guy-spinner-small" width="14" height="14" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10"></circle></svg> Suggesting...');try{if(!chrome.runtime?.id)throw new Error("Extension context invalidated");const e=await chrome.runtime.sendMessage({action:"getSuggestResearch",data:{originalTweet:this.tweet,responseIdea:this.responseIdea,responseType:this.responseType,tone:this.tone}});e.success&&e.data?.suggestions&&(this.researchSuggestions=e.data.suggestions,this.showResearchSuggestions())}catch(e){console.error("[ReplyGuy] Research suggest error:",e),e instanceof Error&&e.message.includes("Extension context invalidated")&&alert("Reply Guy extension needs to be refreshed. Please reload this page.")}finally{n&&(n.disabled=!1,n.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2L13.09 8.26L19 7L15.45 11.82L21 16L14.5 16.5L15 23L10.18 17.45L5 21L5.5 14.5L0 16L5.55 11.18L2 7L7.91 8.26L9 2L12 2Z" fill="currentColor"/></svg> Suggest')}});const l=this.overlay.querySelector("#reply-guy-meme"),c=this.overlay.querySelector("#reply-guy-meme-options"),p=this.overlay.querySelector("#reply-guy-meme-text"),y=this.overlay.querySelector("#reply-guy-meme-mode-section"),d=this.overlay.querySelector("#meme-info-empty"),u=this.overlay.querySelector("#meme-info-exact"),g=this.overlay.querySelector("#meme-info-enhance"),h=this.overlay.querySelector("#meme-preview-text");if(l&&this.userPlan){const e=this.userPlan.memes_used<this.userPlan.meme_limit;if(l.disabled=!e,e)l.checked=this.includeMeme,c&&(c.style.display=this.includeMeme?"block":"none");else{const e=l.parentElement;e&&(e.style.opacity="0.5",e.style.cursor="not-allowed")}}l?.addEventListener("change",()=>{this.includeMeme=l.checked,c&&(c.style.display=this.includeMeme?"block":"none"),this.includeMeme||(this.memeText="",p&&(p.value=""))});const m=()=>{const e=this.memeText.trim().length>0;if(y&&(y.style.display=e?"block":"none"),e){h&&(h.textContent=this.memeText);const e="exact"===this.memeTextMode;d&&(d.style.display="none"),u&&(u.style.display=e?"block":"none"),g&&(g.style.display=e?"none":"block")}else d&&(d.style.display="block"),u&&(u.style.display="none"),g&&(g.style.display="none")};p?.addEventListener("input",()=>{this.memeText=p.value,m()}),this.overlay.querySelectorAll('input[name="memeTextMode"]').forEach(e=>{e.addEventListener("change",e=>{this.memeTextMode=e.target.value,m()})});const x=this.overlay.querySelector("#reply-guy-write-like-me");x&&(x.checked=this.useCustomStyle,x.addEventListener("change",()=>{this.useCustomStyle=x.checked}));const f=this.overlay.querySelector("#reply-guy-match-style");f?.addEventListener("change",()=>{this.enableStyleMatching=f.checked}),this.overlay.querySelector("#reply-guy-generate")?.addEventListener("click",()=>{if(!this.responseIdea.trim())return void alert("Please describe what you want to say");const n=this.userPlan?.max_tweet_length||280,t={originalTweet:this.tweet.length>n?this.tweet.substring(0,n)+"...":this.tweet,responseIdea:this.responseIdea,responseType:this.responseType,tone:this.tone,replyLength:this.replyLength,needsResearch:this.needsResearch,perplexityGuidance:this.needsResearch?this.perplexityGuidance:void 0,includeMeme:this.includeMeme,memeText:this.includeMeme&&this.memeText?this.memeText:void 0,memeTextMode:this.includeMeme&&this.memeText?this.memeTextMode:void 0,useCustomStyle:this.useCustomStyle,enableStyleMatching:this.enableStyleMatching};console.log("[ReplyGuy] Generating with data:",t);const o=this.overlay?.querySelector("#reply-guy-save-defaults");o?.checked&&this.saveUserSettings(),e(t)})}getComprehensiveStyles(){return'\n      .reply-guy-overlay {\n        position: fixed;\n        z-index: 10000;\n        background: white;\n        border-radius: 16px;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        overflow: hidden;\n        animation: slideIn 0.3s ease-out;\n        display: flex;\n        flex-direction: column;\n        max-height: 80vh; /* Limit to 80% of viewport height */\n      }\n\n      @keyframes slideIn {\n        from {\n          opacity: 0;\n          transform: translateY(-20px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      .reply-guy-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 16px 20px;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: white;\n        flex-shrink: 0; /* Prevent header from shrinking */\n      }\n\n      .reply-guy-title {\n        display: flex;\n        align-items: center;\n        font-size: 18px;\n        font-weight: 600;\n        gap: 10px;\n      }\n      \n      .reply-guy-logo-icon {\n        width: 28px;\n        height: 28px;\n        filter: brightness(0) invert(1);\n      }\n\n      .reply-guy-close {\n        width: 32px;\n        height: 32px;\n        border: none;\n        background: rgba(255, 255, 255, 0.2);\n        color: white;\n        border-radius: 8px;\n        cursor: pointer;\n        font-size: 24px;\n        line-height: 1;\n        transition: all 0.2s;\n      }\n\n      .reply-guy-close:hover {\n        background: rgba(255, 255, 255, 0.3);\n        transform: scale(1.05);\n      }\n      \n      .reply-guy-content {\n        padding: 20px;\n        overflow-y: auto;\n        flex: 1;\n        max-height: calc(80vh - 80px); /* Account for header height */\n      }\n      \n      /* Sections */\n      details {\n        margin-bottom: 16px;\n        border: 1px solid #e9ecef;\n        border-radius: 12px;\n        overflow: hidden;\n      }\n      \n      details summary {\n        padding: 12px 16px;\n        background: #f8f9fa;\n        cursor: pointer;\n        font-weight: 500;\n        color: #495057;\n        user-select: none;\n        transition: background 0.2s;\n      }\n      \n      details summary:hover {\n        background: #e9ecef;\n      }\n      \n      details[open] summary {\n        border-bottom: 1px solid #e9ecef;\n      }\n      \n      .reply-guy-tweet-preview {\n        padding: 16px;\n        font-size: 14px;\n        line-height: 1.5;\n        color: #6c757d;\n        max-height: 150px;\n        overflow-y: auto;\n      }\n      \n      .reply-guy-row {\n        display: flex;\n        gap: 12px;\n        margin-bottom: 20px;\n      }\n      \n      .reply-guy-half {\n        flex: 1;\n      }\n      \n      .reply-guy-select {\n        width: 100%;\n        padding: 10px 12px;\n        border: 2px solid #e9ecef;\n        border-radius: 8px;\n        font-size: 14px;\n        color: #212529; /* Explicitly set text color */\n        transition: all 0.2s;\n        font-family: inherit;\n        background: white;\n        cursor: pointer;\n        -webkit-appearance: none; /* Remove default styling */\n      }\n      \n      .reply-guy-select option {\n        color: #212529; /* Ensure option text is visible */\n        background: white;\n      }\n      \n      .reply-guy-select:focus {\n        outline: none;\n        border-color: #667eea;\n        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\n      }\n      \n      .reply-guy-main-section {\n        margin-bottom: 16px;\n      }\n      \n      .reply-guy-advanced-content,\n      .reply-guy-extras-content {\n        padding: 16px;\n      }\n      \n      /* Form Elements */\n      .reply-guy-option-group {\n        margin-bottom: 20px;\n      }\n      \n      .reply-guy-option-label {\n        display: block;\n        font-size: 12px;\n        font-weight: 600;\n        color: #6c757d;\n        text-transform: uppercase;\n        margin-bottom: 8px;\n        letter-spacing: 0.5px;\n      }\n      \n      .reply-guy-label-with-action {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 8px;\n      }\n      \n      \n      .reply-guy-text-input,\n      .reply-guy-idea-input {\n        width: 100%;\n        padding: 10px 12px;\n        border: 2px solid #e9ecef;\n        border-radius: 8px;\n        font-size: 14px;\n        transition: all 0.2s;\n        font-family: inherit;\n      }\n      \n      .reply-guy-text-input:focus,\n      .reply-guy-idea-input:focus {\n        outline: none;\n        border-color: #667eea;\n        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\n      }\n      \n      .reply-guy-idea-input {\n        resize: vertical;\n        min-height: 60px;\n      }\n      \n      .reply-guy-idea-input.error {\n        border-color: #dc3545;\n      }\n      \n      .reply-guy-char-count {\n        text-align: right;\n        font-size: 12px;\n        color: #6c757d;\n        margin-top: 4px;\n      }\n      \n      .reply-guy-suggest-btn {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        padding: 4px 12px;\n        background: #f8f9fa;\n        border: 1px solid #e9ecef;\n        border-radius: 6px;\n        font-size: 12px;\n        color: #667eea;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n      \n      .reply-guy-suggest-btn:hover {\n        background: #e9ecef;\n        border-color: #667eea;\n      }\n      \n      /* Radio and Checkbox */\n      .reply-guy-length-options,\n      .reply-guy-meme-mode {\n        display: flex;\n        gap: 12px;\n        flex-wrap: wrap;\n      }\n      \n      .reply-guy-radio,\n      .reply-guy-checkbox {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        cursor: pointer;\n        font-size: 14px;\n        color: #495057;\n      }\n      \n      .reply-guy-radio input[type="radio"],\n      .reply-guy-checkbox input[type="checkbox"] {\n        cursor: pointer;\n      }\n      \n      .reply-guy-radio input[type="radio"]:disabled + span,\n      .reply-guy-checkbox input[type="checkbox"]:disabled + span {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n      \n      .reply-guy-option-hint {\n        font-size: 11px;\n        color: #868e96;\n        margin-top: 4px;\n        margin-left: 24px;\n      }\n      \n      /* Save Defaults */\n      .reply-guy-save-defaults {\n        margin: 16px 0;\n        padding: 12px 16px;\n        background: #f8f9fa;\n        border-radius: 8px;\n      }\n      \n      .reply-guy-checkbox {\n        display: flex;\n        align-items: center;\n        cursor: pointer;\n        font-size: 14px;\n        color: #495057;\n      }\n      \n      .reply-guy-checkbox input {\n        margin-right: 8px;\n      }\n      \n      /* Action Buttons */\n      .reply-guy-actions {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-top: 24px;\n        padding-top: 20px;\n        border-top: 1px solid #e9ecef;\n      }\n      \n      .reply-guy-generate-btn {\n        flex: 1;\n        padding: 14px 24px;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: white;\n        border: none;\n        border-radius: 10px;\n        font-size: 16px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s;\n        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);\n      }\n      \n      .reply-guy-generate-btn:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);\n      }\n      \n      .reply-guy-generate-btn:active {\n        transform: translateY(0);\n      }\n      \n      .reply-guy-usage {\n        margin-left: 16px;\n        font-size: 13px;\n        color: #6c757d;\n        white-space: nowrap;\n        display: flex;\n        flex-direction: column;\n        align-items: flex-end;\n        gap: 2px;\n      }\n      \n      .reply-guy-usage-remaining {\n        font-weight: 600;\n        color: #495057;\n      }\n      \n      .reply-guy-usage-detail {\n        font-size: 11px;\n        color: #adb5bd;\n      }\n      \n      .reply-guy-daily-goal {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        margin-top: 8px;\n        padding: 8px 12px;\n        background: #f8f9fa;\n        border-radius: 8px;\n        font-size: 13px;\n        color: #495057;\n      }\n      \n      .reply-guy-daily-icon {\n        font-size: 16px;\n      }\n      \n      .reply-guy-daily-text {\n        font-weight: 500;\n      }\n      \n      /* Research suggestions */\n      .reply-guy-suggestion-label {\n        font-size: 12px;\n        font-weight: 600;\n        color: #6c757d;\n        margin-bottom: 6px;\n      }\n      \n      .reply-guy-suggestion-chips {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 6px;\n      }\n      \n      .reply-guy-suggestion-chip {\n        padding: 6px 12px;\n        background: #f8f9fa;\n        border: 1px solid #e9ecef;\n        border-radius: 16px;\n        font-size: 12px;\n        color: #495057;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n      \n      .reply-guy-suggestion-chip:hover {\n        background: #e9ecef;\n        border-color: #667eea;\n        color: #667eea;\n      }\n      \n      /* Meme styles */\n      .reply-guy-meme-usage {\n        font-size: 11px;\n        color: #6c757d;\n        margin-left: 8px;\n      }\n      \n      .reply-guy-meme-info {\n        margin-top: 8px;\n        padding: 8px;\n        background: #f8f9fa;\n        border-radius: 6px;\n        font-size: 12px;\n        color: #495057;\n      }\n      \n      .reply-guy-meme-info p {\n        margin: 0;\n      }\n      \n      .reply-guy-meme-info strong {\n        font-weight: 600;\n      }\n      \n      /* Spinner for loading */\n      .reply-guy-spinner-small {\n        animation: spin 1s linear infinite;\n        display: inline-block;\n        vertical-align: middle;\n      }\n      \n      /* Loading States */\n      .reply-guy-loading {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 60px;\n        gap: 16px;\n      }\n      \n      .reply-guy-loading img {\n        animation: pulse 2s ease-in-out infinite;\n      }\n      \n      @keyframes pulse {\n        0%, 100% {\n          transform: scale(1);\n          opacity: 1;\n        }\n        50% {\n          transform: scale(1.05);\n          opacity: 0.8;\n        }\n      }\n      \n      .reply-guy-spinner {\n        width: 40px;\n        height: 40px;\n        border: 3px solid #f3f3f3;\n        border-top: 3px solid #667eea;\n        border-radius: 50%;\n        animation: spin 1s linear infinite;\n      }\n      \n      @keyframes spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n      \n      /* Loading dots animation */\n      .reply-guy-loading-text {\n        color: #666;\n        font-size: 16px;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n      }\n      \n      .reply-guy-loading-dots {\n        display: inline-flex;\n        gap: 3px;\n      }\n      \n      .reply-guy-loading-dot {\n        width: 6px;\n        height: 6px;\n        background: #667eea;\n        border-radius: 50%;\n        display: inline-block;\n        animation: loadingDot 1.4s infinite ease-in-out both;\n      }\n      \n      .reply-guy-loading-dot:nth-child(1) {\n        animation-delay: -0.32s;\n      }\n      \n      .reply-guy-loading-dot:nth-child(2) {\n        animation-delay: -0.16s;\n      }\n      \n      @keyframes loadingDot {\n        0%, 80%, 100% {\n          transform: scale(0.8);\n          opacity: 0.5;\n        }\n        40% {\n          transform: scale(1.2);\n          opacity: 1;\n        }\n      }\n      \n      /* Error State */\n      .reply-guy-error {\n        padding: 20px;\n        text-align: center;\n        color: #dc3545;\n        background: #f8d7da;\n        border: 1px solid #f5c6cb;\n        border-radius: 8px;\n        margin: 16px;\n      }\n    '}showGeneratedReply(e,n,t){this.remove(),this.currentReplyData=t||{},this.overlay=document.createElement("div"),this.overlay.className="reply-guy-overlay",this.overlay.innerHTML=`\n      <style>\n        ${this.getComprehensiveStyles()}\n        /* Override to ensure proper flex layout for result display */\n        .reply-guy-overlay {\n          display: flex !important;\n          flex-direction: column !important;\n          max-height: 80vh !important;\n        }\n        .reply-guy-content-scroll {\n          overflow-y: auto;\n          flex: 1;\n          padding: 20px;\n          min-height: 0; /* Important for Firefox */\n        }\n        .reply-guy-reply-text {\n          background: #f8f9fa;\n          border: 2px solid #e9ecef;\n          border-radius: 12px;\n          padding: 16px;\n          font-size: 15px;\n          line-height: 1.5;\n          color: #212529;\n          margin-bottom: 16px;\n        }\n        .reply-guy-meme-preview {\n          margin-bottom: 16px;\n          text-align: center;\n        }\n        .reply-guy-meme-preview img {\n          width: 100%;\n          max-width: 300px;\n          max-height: 300px;\n          height: auto;\n          object-fit: contain;\n          border-radius: 12px;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n        }\n        .reply-guy-result-footer {\n          flex-shrink: 0;\n          padding: 0 20px 20px;\n          border-top: 1px solid #e9ecef;\n          background: white;\n        }\n        .reply-guy-result-actions {\n          display: flex;\n          gap: 12px;\n          padding-top: 16px;\n          justify-content: center;\n        }\n        .reply-guy-copy-btn, .reply-guy-edit-btn {\n          padding: 14px 24px;\n          border: none;\n          border-radius: 10px;\n          font-size: 15px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.2s;\n          min-width: 140px;\n        }\n        .reply-guy-copy-btn {\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);\n        }\n        .reply-guy-copy-btn:hover {\n          transform: translateY(-1px);\n          box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);\n        }\n        .reply-guy-copy-btn.copied {\n          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);\n        }\n        .reply-guy-edit-btn {\n          background: white;\n          color: #667eea;\n          border: 2px solid #667eea;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        }\n        .reply-guy-edit-btn:hover {\n          background: #f8f9ff;\n          transform: translateY(-1px);\n          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);\n        }\n        .reply-guy-notice {\n          margin-top: 12px;\n          padding: 12px 16px;\n          border-radius: 8px;\n          font-size: 14px;\n          text-align: center;\n        }\n        .reply-guy-copy-notice {\n          background: #d4edda;\n          border: 1px solid #c3e6cb;\n          color: #155724;\n        }\n        .reply-guy-meme-notice {\n          background: #d1ecf1;\n          border: 1px solid #bee5eb;\n          color: #0c5460;\n        }\n      </style>\n      <div class="reply-guy-header">\n        <div class="reply-guy-title">\n          <img src="${chrome.runtime.getURL("icons/reply_guy_logo.png")}" class="reply-guy-logo-icon" alt="Reply Guy" />\n          <span>Your Reply is Ready!</span>\n        </div>\n        <button class="reply-guy-close" aria-label="Close">√ó</button>\n      </div>\n      \n      <div class="reply-guy-content-scroll">\n        <div class="reply-guy-reply-text">\n          ${this.escapeHtml(e)}\n        </div>\n        \n        ${n?`\n        <div class="reply-guy-meme-preview">\n          <img src="${n}" alt="Generated meme" />\n        </div>\n        `:""}\n      </div>\n      \n      <div class="reply-guy-result-footer">\n        <div class="reply-guy-result-actions">\n          <button class="reply-guy-copy-btn">${n?"üìã Copy & Download":"üìã Copy Reply"}</button>\n          <button class="reply-guy-edit-btn">‚úèÔ∏è Edit</button>\n        </div>\n        \n        <div class="reply-guy-copy-notice reply-guy-notice" style="display: none;">\n          ‚úÖ Reply copied! Click in the reply box and paste with <strong>Ctrl+V</strong> (or <strong>Cmd+V</strong> on Mac)\n        </div>\n        \n        ${n?'\n        <div class="reply-guy-meme-notice reply-guy-notice" style="display: none;">\n          üñºÔ∏è Meme will open in a new window\n        </div>\n        ':""}\n      </div>\n    `;const o=this.container.getBoundingClientRect();this.overlay.style.position="fixed";const i=.8*window.innerHeight;window.innerHeight-o.bottom-16<i&&o.top>i?(this.overlay.style.bottom=window.innerHeight-o.top+8+"px",this.overlay.style.top="auto"):this.overlay.style.top=`${Math.min(o.bottom+8,window.innerHeight-i)}px`,this.overlay.style.left=`${Math.min(o.left,window.innerWidth-500)}px`,this.overlay.style.width="480px",this.overlay.querySelector(".reply-guy-close")?.addEventListener("click",()=>this.remove());const r=this.overlay.querySelector(".reply-guy-copy-btn"),s=this.overlay.querySelector(".reply-guy-edit-btn"),a=this.overlay.querySelector(".reply-guy-copy-notice");r?.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(e),r.textContent="‚úÖ Copied!",r.classList.add("copied"),a&&(a.style.display="block");try{const e=await chrome.runtime.sendMessage({action:"getUsageLimits"});if(e.success&&e.data){const{dailyCount:n,dailyGoal:t}=e.data;if(void 0!==n&&void 0!==t&&n>=t){const e=`celebration_shown_${(new Date).toDateString()}`;chrome.storage.local.get(e,n=>{n[e]||(chrome.runtime.sendMessage({action:"triggerPopupCelebration"}),chrome.storage.local.set({[e]:!0}))})}}}catch(e){console.error("[ReplyGuy] Failed to check celebration status:",e)}if(n)try{if(window.open(n,"_blank","width=600,height=600,toolbar=no,menubar=no,location=no,status=no")){const e=this.overlay?.querySelector(".reply-guy-meme-notice");e&&(e.innerHTML="üñºÔ∏è Meme opened in new window! Right-click the image and save it, then drag into X or use the photo button",e.style.display="block"),console.log("[ReplyGuy] Meme opened in new window"),setTimeout(()=>{window.focus()},100)}else{window.open(n,"_blank");const e=this.overlay?.querySelector(".reply-guy-meme-notice");e&&(e.innerHTML="üñºÔ∏è Meme opened in new tab! Right-click to save it, then return here to paste your reply",e.style.display="block"),console.log("[ReplyGuy] Meme opened in new tab (popup blocked)")}}catch(e){console.error("[ReplyGuy] Failed to open meme in new window:",e);const t=this.overlay?.querySelector(".reply-guy-meme-notice");t&&(t.innerHTML=`üñºÔ∏è <a href="${n}" target="_blank" style="color: #0c5460; text-decoration: underline;">Click here to open meme</a> - then right-click to save`,t.style.display="block")}const t=document.querySelector('[data-testid="tweetTextarea_0"]')||document.querySelector('[role="textbox"][contenteditable="true"]')||this.container.querySelector('[role="textbox"]');t&&t.focus(),setTimeout(()=>{this.remove()},n?3500:2500)}catch(e){console.error("[ReplyGuy] Failed to copy to clipboard:",e),alert("Failed to copy. Please select the text and copy manually.")}}),s?.addEventListener("click",()=>{this.showEditMode(e)}),setTimeout(()=>{document.addEventListener("click",this.handleOutsideClick)},0),document.body.appendChild(this.overlay)}showEditMode(e){this.remove(),this.overlay=document.createElement("div"),this.overlay.className="reply-guy-overlay",this.overlay.innerHTML=`\n      <style>\n        ${this.getComprehensiveStyles()}\n        /* Edit mode specific styles */\n        .reply-guy-edit-container {\n          padding: 20px;\n        }\n        .reply-guy-edit-section {\n          margin-bottom: 20px;\n        }\n        .reply-guy-edit-label {\n          display: block;\n          font-size: 14px;\n          font-weight: 600;\n          color: #536471;\n          margin-bottom: 8px;\n        }\n        .reply-guy-context-box {\n          background: #f7f9fa;\n          border: 1px solid #e1e8ed;\n          border-radius: 8px;\n          padding: 12px;\n          font-size: 14px;\n          color: #536471;\n          margin-bottom: 8px;\n        }\n        .reply-guy-edit-textarea {\n          width: 100%;\n          padding: 12px;\n          border: 2px solid #e1e8ed;\n          border-radius: 8px;\n          font-size: 15px;\n          line-height: 1.5;\n          resize: vertical;\n          min-height: 100px;\n          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n          transition: border-color 0.2s;\n        }\n        .reply-guy-edit-textarea:focus {\n          outline: none;\n          border-color: #667eea;\n        }\n        .reply-guy-edit-input {\n          width: 100%;\n          padding: 10px 12px;\n          border: 2px solid #e1e8ed;\n          border-radius: 8px;\n          font-size: 14px;\n          transition: border-color 0.2s;\n        }\n        .reply-guy-edit-input:focus {\n          outline: none;\n          border-color: #667eea;\n        }\n        .reply-guy-char-count {\n          text-align: right;\n          font-size: 13px;\n          color: #536471;\n          margin-top: 4px;\n        }\n        .reply-guy-edit-actions {\n          display: flex;\n          gap: 12px;\n          justify-content: flex-end;\n          margin-top: 20px;\n        }\n        .reply-guy-save-btn {\n          padding: 10px 24px;\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          border: none;\n          border-radius: 8px;\n          font-size: 15px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.2s;\n        }\n        .reply-guy-save-btn:hover:not(:disabled) {\n          transform: translateY(-1px);\n          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);\n        }\n        .reply-guy-save-btn:disabled {\n          opacity: 0.6;\n          cursor: not-allowed;\n        }\n        .reply-guy-cancel-btn {\n          padding: 10px 24px;\n          background: white;\n          color: #536471;\n          border: 2px solid #e1e8ed;\n          border-radius: 8px;\n          font-size: 15px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.2s;\n        }\n        .reply-guy-cancel-btn:hover {\n          background: #f7f9fa;\n          border-color: #d1d5da;\n        }\n      </style>\n      <div class="reply-guy-header">\n        <div class="reply-guy-title">\n          <img src="${chrome.runtime.getURL("icons/reply_guy_logo.png")}" class="reply-guy-logo-icon" alt="Reply Guy" />\n          <span>Improve Your Writing Style</span>\n        </div>\n        <button class="reply-guy-close" aria-label="Close">√ó</button>\n      </div>\n      \n      <div class="reply-guy-edit-container">\n        <div class="reply-guy-edit-section" style="background: #f0f7ff; padding: 12px; border-radius: 8px; margin-bottom: 16px;">\n          <p style="margin: 0; font-size: 14px; color: #536471; line-height: 1.5;">\n            Edit the reply to match how YOU would write it. When you save, your edited reply will be <strong>automatically copied</strong> to the clipboard and your feedback will help improve your writing style.\n          </p>\n        </div>\n        \n        <div class="reply-guy-edit-section">\n          <label class="reply-guy-edit-label">Original Tweet</label>\n          <div class="reply-guy-context-box">\n            ${this.escapeHtml(this.originalTweet||"Tweet content not available")}\n          </div>\n        </div>\n        \n        <div class="reply-guy-edit-section">\n          <label class="reply-guy-edit-label">Your Idea</label>\n          <div class="reply-guy-context-box">\n            ${this.escapeHtml(this.responseIdea||"Response idea not available")}\n          </div>\n        </div>\n        \n        <div class="reply-guy-edit-section">\n          <label class="reply-guy-edit-label" for="reply-guy-edited-reply">\n            ‚ú® Edit to match your style\n          </label>\n          <textarea \n            id="reply-guy-edited-reply" \n            class="reply-guy-edit-textarea"\n            placeholder="Edit this to match how YOU would write it"\n            maxlength="280"\n          >${this.escapeHtml(e)}</textarea>\n          <div class="reply-guy-char-count">\n            <span id="reply-guy-char-current">${e.length}</span>/280 characters\n          </div>\n        </div>\n        \n        <div class="reply-guy-edit-section">\n          <label class="reply-guy-edit-label" for="reply-guy-correction-notes">\n            What did we get wrong? (Optional)\n          </label>\n          <input \n            type="text"\n            id="reply-guy-correction-notes" \n            class="reply-guy-edit-input"\n            placeholder="e.g., 'Too formal' or 'I never use exclamation marks'"\n          />\n        </div>\n        \n        <div class="reply-guy-edit-actions">\n          <button class="reply-guy-cancel-btn">Cancel</button>\n          <button class="reply-guy-save-btn" id="reply-guy-save-edit">Save & Copy Edited Reply</button>\n        </div>\n      </div>\n    `,this.container.getBoundingClientRect(),this.overlay.style.position="fixed";const n=Math.min(.8*window.innerHeight,600);this.overlay.style.top="50%",this.overlay.style.left="50%",this.overlay.style.transform="translate(-50%, -50%)",this.overlay.style.width="520px",this.overlay.style.maxHeight=`${n}px`,this.overlay.style.overflowY="auto";const t=this.overlay.querySelector(".reply-guy-close"),o=this.overlay.querySelector(".reply-guy-cancel-btn"),i=this.overlay.querySelector("#reply-guy-save-edit"),r=this.overlay.querySelector("#reply-guy-edited-reply"),s=this.overlay.querySelector("#reply-guy-char-current"),a=this.overlay.querySelector("#reply-guy-correction-notes");t?.addEventListener("click",()=>this.remove()),o?.addEventListener("click",()=>this.remove()),r?.addEventListener("input",()=>{const n=r.value.length;s&&(s.textContent=n.toString()),i&&(i.disabled=r.value.trim()===e.trim())}),i?.addEventListener("click",async()=>{const n=r.value.trim(),t=a.value.trim();if(n!==e.trim()){i.disabled=!0,i.textContent="Saving...";try{const o=await chrome.runtime.sendMessage({action:"submitCorrection",data:{styleId:this.currentReplyData.styleId,originalTweet:this.originalTweet,responseIdea:this.responseIdea,replyType:this.currentReplyData.replyType||this.responseType,tone:this.currentReplyData.tone||this.tone,generatedReply:e,correctedReply:n,correctionNotes:t}});if(!o.success)throw new Error(o.error||"Failed to save correction");try{await navigator.clipboard.writeText(n),i.textContent="‚úÖ Saved & Copied!";const e=this.overlay?.querySelector(".reply-guy-edit-container");if(e){const n=document.createElement("div");n.className="reply-guy-copy-notice reply-guy-notice",n.style.marginTop="16px",n.innerHTML="‚úÖ Your edited reply has been copied to clipboard and your feedback saved!<br><strong>Paste it with Ctrl+V (or Cmd+V on Mac)</strong>",e.appendChild(n)}setTimeout(()=>{this.remove()},3e3)}catch(e){console.error("[ReplyGuy] Failed to copy to clipboard:",e),i.textContent="‚úÖ Saved! (Copy manually)",r?.select(),setTimeout(()=>{this.remove()},3e3)}}catch(e){console.error("[ReplyGuy] Failed to save correction:",e),i.textContent="Failed - Try Again",i.disabled=!1,setTimeout(()=>{i.textContent="Save & Copy Edited Reply"},2e3)}}}),setTimeout(()=>{r?.focus(),r?.setSelectionRange(r.value.length,r.value.length)},100),document.body.appendChild(this.overlay)}show(e,n){this.remove(),this.overlay=document.createElement("div"),this.overlay.className="reply-guy-overlay",this.overlay.innerHTML=`\n      <style>\n        .reply-guy-overlay {\n          position: absolute;\n          z-index: 10000;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);\n          padding: 16px;\n          max-width: 500px;\n          margin-top: 8px;\n          animation: slideIn 0.2s ease-out;\n        }\n\n        @keyframes slideIn {\n          from {\n            opacity: 0;\n            transform: translateY(-10px);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n\n        .reply-guy-header {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          margin-bottom: 12px;\n          padding-bottom: 12px;\n          border-bottom: 1px solid #e9ecef;\n        }\n\n        .reply-guy-title {\n          display: flex;\n          align-items: center;\n          font-size: 16px;\n          font-weight: 600;\n          color: #1a1a1a;\n        }\n\n        .reply-guy-logo {\n          width: 20px;\n          height: 20px;\n          margin-right: 8px;\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          border-radius: 4px;\n        }\n\n        .reply-guy-close {\n          width: 24px;\n          height: 24px;\n          border: none;\n          background: none;\n          cursor: pointer;\n          color: #6c757d;\n          font-size: 20px;\n          line-height: 1;\n          transition: color 0.2s;\n        }\n\n        .reply-guy-close:hover {\n          color: #1a1a1a;\n        }\n\n        .reply-guy-suggestions {\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n        }\n\n        .reply-guy-suggestion {\n          padding: 12px;\n          background: #f8f9fa;\n          border: 1px solid #e9ecef;\n          border-radius: 8px;\n          cursor: pointer;\n          transition: all 0.2s;\n          font-size: 14px;\n          line-height: 1.5;\n          color: #1a1a1a;\n        }\n\n        .reply-guy-suggestion:hover {\n          background: #e9ecef;\n          border-color: #667eea;\n          transform: translateX(4px);\n        }\n\n        .reply-guy-loading {\n          text-align: center;\n          padding: 40px;\n          color: #6c757d;\n        }\n\n        .reply-guy-spinner {\n          width: 32px;\n          height: 32px;\n          border: 3px solid #f3f3f3;\n          border-top: 3px solid #667eea;\n          border-radius: 50%;\n          animation: spin 1s linear infinite;\n          margin: 0 auto 12px;\n        }\n\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      </style>\n      <div class="reply-guy-header">\n        <div class="reply-guy-title">\n          <div class="reply-guy-logo"></div>\n          Reply Suggestions\n        </div>\n        <button class="reply-guy-close" aria-label="Close">√ó</button>\n      </div>\n      <div class="reply-guy-suggestions">\n        ${e.map((e,n)=>`\n          <div class="reply-guy-suggestion" data-index="${n}">\n            ${this.escapeHtml(e)}\n          </div>\n        `).join("")}\n      </div>\n    `;const t=this.container.getBoundingClientRect();this.overlay.style.position="fixed",this.overlay.style.top=`${t.bottom+window.scrollY}px`,this.overlay.style.left=`${t.left}px`,this.overlay.style.width=`${t.width}px`,this.overlay.querySelector(".reply-guy-close")?.addEventListener("click",()=>this.remove()),this.overlay.querySelectorAll(".reply-guy-suggestion").forEach(t=>{t.addEventListener("click",()=>{const o=parseInt(t.getAttribute("data-index")||"0");n(e[o]),this.remove()})}),setTimeout(()=>{document.addEventListener("click",this.handleOutsideClick)},0),document.body.appendChild(this.overlay)}showLoading(){this.remove(),this.overlay=document.createElement("div"),this.overlay.className="reply-guy-overlay",this.overlay.innerHTML=`\n      <style>\n        ${this.getComprehensiveStyles()}\n      </style>\n      <div class="reply-guy-header">\n        <div class="reply-guy-title">\n          <img src="${chrome.runtime.getURL("icons/reply_guy_logo.png")}" class="reply-guy-logo-icon" alt="Reply Guy" />\n          <span>Reply Guy</span>\n        </div>\n      </div>\n      <div class="reply-guy-loading">\n        <img src="${chrome.runtime.getURL("icons/reply_guy_logo.png")}" alt="Generating..." />\n        <div class="reply-guy-loading-text">\n          Crafting the perfect reply\n          <span class="reply-guy-loading-dots">\n            <span class="reply-guy-loading-dot"></span>\n            <span class="reply-guy-loading-dot"></span>\n            <span class="reply-guy-loading-dot"></span>\n          </span>\n        </div>\n      </div>\n    `;const e=this.container.getBoundingClientRect();this.overlay.style.position="fixed";const n=.8*window.innerHeight;window.innerHeight-e.bottom-16<n&&e.top>n?(this.overlay.style.bottom=window.innerHeight-e.top+8+"px",this.overlay.style.top="auto"):this.overlay.style.top=`${Math.min(e.bottom+8,window.innerHeight-n)}px`,this.overlay.style.left=`${Math.min(e.left,window.innerWidth-500)}px`,this.overlay.style.width="400px",document.body.appendChild(this.overlay)}showError(e){this.remove(),this.overlay=document.createElement("div"),this.overlay.className="reply-guy-overlay",this.overlay.innerHTML=`\n      <style>\n        ${this.getComprehensiveStyles()}\n        .reply-guy-error {\n          padding: 20px;\n          text-align: center;\n          color: #dc3545;\n          font-size: 14px;\n          line-height: 1.5;\n        }\n        .reply-guy-error-icon {\n          font-size: 48px;\n          margin-bottom: 12px;\n        }\n      </style>\n      <div class="reply-guy-header">\n        <div class="reply-guy-title">\n          <img src="${chrome.runtime.getURL("icons/reply_guy_logo.png")}" class="reply-guy-logo-icon" alt="Reply Guy" />\n          <span>Reply Guy</span>\n        </div>\n        <button class="reply-guy-close" aria-label="Close">√ó</button>\n      </div>\n      <div class="reply-guy-error">\n        <div class="reply-guy-error-icon">‚ö†Ô∏è</div>\n        ${this.escapeHtml(e)}\n      </div>\n    `;const n=this.container.getBoundingClientRect();this.overlay.style.position="fixed";const t=.8*window.innerHeight;window.innerHeight-n.bottom-16<t&&n.top>t?(this.overlay.style.bottom=window.innerHeight-n.top+8+"px",this.overlay.style.top="auto"):this.overlay.style.top=`${Math.min(n.bottom+8,window.innerHeight-t)}px`,this.overlay.style.left=`${Math.min(n.left,window.innerWidth-500)}px`,this.overlay.style.width="400px",this.overlay.querySelector(".reply-guy-close")?.addEventListener("click",()=>this.remove()),document.body.appendChild(this.overlay)}remove(){this.overlay&&(this.overlay.remove(),this.overlay=null,document.removeEventListener("click",this.handleOutsideClick))}escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}showResearchSuggestions(){const e=this.overlay?.querySelector("#reply-guy-research-suggestions"),n=this.overlay?.querySelector(".reply-guy-suggestion-chips"),t=this.overlay?.querySelector("#reply-guy-perplexity");e&&n&&this.researchSuggestions.length&&(e.style.display="block",n.innerHTML="",this.researchSuggestions.forEach(e=>{const o=document.createElement("button");o.className="reply-guy-suggestion-chip",o.textContent=e,o.addEventListener("click",()=>{this.perplexityGuidance=e,t&&(t.value=e)}),n.appendChild(o)}))}insertGeneratedReply(e,n){const t=document.querySelector('[data-testid="tweetTextarea_0"]')||document.querySelector('[role="textbox"][contenteditable="true"]')||e.querySelector('[role="textbox"]');if(t){t.focus();const e=new InputEvent("beforeinput",{bubbles:!0,cancelable:!0,inputType:"deleteContentBackward"});t.dispatchEvent(e),t.textContent="";try{if(navigator.clipboard&&window.isSecureContext)return void navigator.clipboard.writeText(n).then(()=>{t.focus();const e=document.createRange();e.selectNodeContents(t);const o=window.getSelection();o?.removeAllRanges(),o?.addRange(e),new ClipboardEvent("paste",{bubbles:!0,cancelable:!0,clipboardData:new DataTransfer}),document.execCommand("insertText",!1,n),console.log("[ReplyGuy] Inserted reply using clipboard method")}).catch(()=>{this.insertUsingInputEvents(t,n)})}catch(e){console.log("[ReplyGuy] Clipboard API not available, using input events")}this.insertUsingInputEvents(t,n)}else console.error("[ReplyGuy] Could not find compose textbox")}insertUsingInputEvents(e,n){e.focus();const t=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set||Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;if(t&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)){t.call(e,n);const o=new Event("input",{bubbles:!0});e.dispatchEvent(o)}else{e.textContent=n;const t=document.createRange(),o=e.firstChild||e;t.setStart(o,e.textContent.length),t.setEnd(o,e.textContent.length);const i=window.getSelection();i?.removeAllRanges(),i?.addRange(t);const r=new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:n}),s=new InputEvent("beforeinput",{bubbles:!0,cancelable:!0,inputType:"insertText",data:n});e.dispatchEvent(s),e.dispatchEvent(r);const a=new CompositionEvent("compositionend",{bubbles:!0,cancelable:!0,data:n});e.dispatchEvent(a)}e.focus(),console.log("[ReplyGuy] Inserted reply using input events")}}class n{constructor(){this.observer=null,this.overlays=new WeakMap,this.isAuthenticated=!1}initialize(){console.log("[ReplyGuy] Initializing X integration"),console.log("[ReplyGuy] Current URL:",window.location.href),chrome.runtime?.id?(chrome?.runtime?.sendMessage&&chrome.runtime.sendMessage({action:"checkAuth"}).then(e=>{e?.success&&(this.isAuthenticated=e.data?.isAuthenticated||!1,console.log("[ReplyGuy] Auth status:",this.isAuthenticated))}).catch(e=>{e?.message?.includes("Extension context invalidated")?console.error("[ReplyGuy] Extension context invalidated during auth check"):console.error("[ReplyGuy] Failed to check auth:",e)}),this.setupObserver(),setTimeout(()=>this.injectReplyButtons(),1e3),setTimeout(()=>this.injectReplyButtons(),3e3)):console.error("[ReplyGuy] Extension context invalid during initialization")}cleanup(){this.observer&&(this.observer.disconnect(),this.observer=null),document.querySelectorAll('[data-testid="replyguy"]').forEach(e=>e.remove())}handleUrlChange(){setTimeout(()=>this.injectReplyButtons(),500)}setupObserver(){let e=null;this.observer=new MutationObserver(n=>{e&&clearTimeout(e),e=setTimeout(()=>{n.some(e=>"childList"===e.type&&e.addedNodes.length>0&&Array.from(e.addedNodes).some(e=>e instanceof Element&&(e.matches("article")||e.querySelector("article"))))&&(console.log("[ReplyGuy] New tweets detected, checking for unprocessed tweets"),this.injectReplyButtons())},800)}),this.observer.observe(document.body,{childList:!0,subtree:!0})}injectReplyButtons(){console.log("[ReplyGuy] Looking for reply buttons..."),console.log("[ReplyGuy] Current page has",document.querySelectorAll("article").length,"tweet articles"),console.log("[ReplyGuy] URL:",window.location.href),console.log("[ReplyGuy] Extension context valid:",!!chrome.runtime?.id);const e=this.findReplyButtons();console.log("[ReplyGuy] Found",e.length,"reply buttons"),e.forEach((e,n)=>{const t=e.closest("article");if(t){const o=e.closest('[role="group"]'),i=o?.querySelector('[data-testid="replyguy"]');i?console.log(`[ReplyGuy] Button already exists for tweet ${n+1}`):(console.log(`[ReplyGuy] Injecting button for tweet ${n+1}`),this.createReplyGuyIcon(e,t))}else console.log(`[ReplyGuy] No article found for reply button ${n+1}`)})}findReplyButtons(){const e=['[data-testid="reply"]','[aria-label*="Reply"]','[role="button"][aria-label*="Reply"]','div[role="button"] svg path[d*="M1.751 10c0-4.42"]'];let n=[];for(const t of e){const e=document.querySelectorAll(t);if(console.log(`[ReplyGuy] Selector "${t}" found ${e.length} elements`),e.length>0){console.log(`[ReplyGuy] Using ${e.length} reply buttons with selector: ${t}`),n=Array.from(e);break}}if(0===n.length){console.log("[ReplyGuy] No reply buttons found with any selector"),console.log("[ReplyGuy] Sample of buttons on page:");const e=document.querySelectorAll('[role="button"]');console.log(`[ReplyGuy] Total buttons with role="button": ${e.length}`),e.length>0&&Array.from(e).slice(0,5).forEach((e,n)=>{console.log(`[ReplyGuy] Button ${n}:`,e.getAttribute("aria-label"),e.getAttribute("data-testid"))})}return n}createReplyGuyIcon(e,n){const t=document.createElement("div");t.id=`replyguy-btn-${Date.now()}`,t.setAttribute("role","button"),t.setAttribute("data-testid","replyguy"),t.setAttribute("tabindex","0"),Object.assign(t.style,{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"34px",height:"34px",marginLeft:"8px",marginRight:"8px",cursor:"pointer",position:"relative",borderRadius:"50%",transition:"transform 0.2s ease, background-color 0.2s ease",zIndex:"1000"}),t.innerHTML=`<img src="${chrome.runtime.getURL("icons/reply_guy_logo.png")}" style="width: 20px; height: 20px;" />`,t.addEventListener("mouseenter",()=>{t.style.transform="scale(1.1)",t.style.backgroundColor="rgba(102, 126, 234, 0.1)"}),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1)",t.style.backgroundColor="transparent"}),t.addEventListener("click",e=>{e.stopPropagation(),this.handleReplyGuyClick(n)});let o=null,i="";const r=e.closest('[role="group"]');if(r&&(o=r,i="role=group"),!o){let n=e.parentElement;for(;n&&n!==document.body;){if(n.querySelectorAll('[role="button"]').length>=3){o=n,i="multiple-buttons-parent";break}n=n.parentElement}}if(!o&&e.parentElement&&(o=e.parentElement,i="direct-parent"),o){if("role=group"===i){const n=Array.from(o.children).filter(e=>"button"===e.getAttribute("role")||e.querySelector('[role="button"]'));n.length>=2?o.insertBefore(t,n[1]):e.parentElement&&e.parentElement.parentElement===o?o.insertBefore(t,e.parentElement.nextSibling):o.appendChild(t)}else e.parentElement&&e.parentElement.parentElement===o?o.insertBefore(t,e.parentElement.nextSibling):o.appendChild(t);console.log(`[ReplyGuy] Button injected using strategy: ${i}`),console.log(`[ReplyGuy] Button ID: ${t.id}`),console.log("[ReplyGuy] Button visibility:",{offsetWidth:t.offsetWidth,offsetHeight:t.offsetHeight,display:window.getComputedStyle(t).display,visibility:window.getComputedStyle(t).visibility})}else console.log("[ReplyGuy] Could not find suitable container for button")}async handleReplyGuyClick(n){if(console.log("[ReplyGuy] Button clicked"),!chrome.runtime?.id)return console.error("[ReplyGuy] Extension context invalidated"),void alert("Reply Guy extension needs to be refreshed. Please reload this page.");try{const e=await chrome.runtime.sendMessage({action:"checkAuth"});if(!e?.success||!e.data?.isAuthenticated)return console.log("[ReplyGuy] User not authenticated, prompting to login"),void(confirm("Please sign in to Reply Guy to use this feature. Would you like to sign in now?")&&chrome.runtime.sendMessage({action:"openLogin"}).catch(e=>{console.error("[ReplyGuy] Failed to open login:",e)}))}catch(e){return e instanceof Error&&e.message.includes("Extension context invalidated")?(console.error("[ReplyGuy] Extension context invalidated"),void alert("Reply Guy extension needs to be refreshed. Please reload this page.")):void console.error("[ReplyGuy] Auth check error:",e)}const t=n.querySelector('[data-testid="tweetText"]'),o=t?.textContent?.trim()||"";if(!o)return console.error("[ReplyGuy] Could not find tweet text"),void alert("Could not find tweet text. Please try again.");console.log("[ReplyGuy] Tweet text:",o.substring(0,50)+"...");const i=n.querySelector('[data-testid="reply"]');if(!i)return console.error("[ReplyGuy] Could not find reply button"),void alert("Could not find reply button. Please try again.");try{i.click(),setTimeout(async()=>{const n=document.querySelector('[data-testid="tweetTextarea_0_label"]')?.parentElement;if(!n)return console.error("Could not find compose area"),void alert("Could not find compose area. Please try clicking reply again.");let t=this.overlays.get(n);t||(t=new e(n),this.overlays.set(n,t)),t.showOptions(o,async e=>{t.showLoading();try{if(!chrome.runtime?.id)return void t.showError("Extension needs to be refreshed. Please reload this page.");const n=await chrome.runtime.sendMessage({action:"generateReply",data:e});if(console.log("[ReplyGuy] Generate reply response:",n),n.success){const e=n.data.data||n.data;console.log("[ReplyGuy] Reply data extracted:",e),e.trackingStatus?(console.log("[ReplyGuy] üìä Daily Usage Tracking Status:",{success:e.trackingStatus.success,date:e.trackingStatus.date,timezone:e.trackingStatus.timezone,error:e.trackingStatus.error||"none"}),e.trackingStatus.success||console.error("[ReplyGuy] ‚ùå Failed to track daily usage:",e.trackingStatus.error)):console.warn("[ReplyGuy] ‚ö†Ô∏è No tracking status returned from API"),t.showGeneratedReply(e.reply||"Failed to generate reply",e.memeUrl,e),chrome.runtime.sendMessage({action:"checkForCelebration"})}else t.showError(n.error||"Failed to generate reply")}catch(e){e instanceof Error&&e.message.includes("Extension context invalidated")?t.showError("Extension needs to be refreshed. Please reload this page."):t.showError("Failed to connect to Reply Guy. Please make sure you are logged in."),console.error("[ReplyGuy] Error generating reply:",e)}})},500)}catch(e){console.error("[ReplyGuy] Error in reply process:",e),alert("An error occurred. Please try again.")}}insertSuggestion(e,n){const t=e.querySelector('[role="textbox"]');if(t){t.innerText=n;const e=new Event("input",{bubbles:!0});t.dispatchEvent(e),t.focus()}}insertGeneratedReply(e,n){const t=e.querySelector('[role="textbox"]');if(t){const e=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;if(e){e.call(t,n);const o=new Event("input",{bubbles:!0});t.dispatchEvent(o),t.focus()}else{t.innerText=n;const e=new Event("input",{bubbles:!0});t.dispatchEvent(e),t.focus()}}}}var t={};!function e(n,t,o,i){var r=!!(n.Worker&&n.Blob&&n.Promise&&n.OffscreenCanvas&&n.OffscreenCanvasRenderingContext2D&&n.HTMLCanvasElement&&n.HTMLCanvasElement.prototype.transferControlToOffscreen&&n.URL&&n.URL.createObjectURL),s="function"==typeof Path2D&&"function"==typeof DOMMatrix,a=function(){if(!n.OffscreenCanvas)return!1;var e=new OffscreenCanvas(1,1),t=e.getContext("2d");t.fillRect(0,0,1,1);var o=e.transferToImageBitmap();try{t.createPattern(o,"no-repeat")}catch(e){return!1}return!0}();function l(){}function c(e){var o=t.exports.Promise,i=void 0!==o?o:n.Promise;return"function"==typeof i?new i(e):(e(l,l),null)}var p,y,d,u,g,h,m,x,f,v,b,w=(p=a,y=new Map,{transform:function(e){if(p)return e;if(y.has(e))return y.get(e);var n=new OffscreenCanvas(e.width,e.height);return n.getContext("2d").drawImage(e,0,0),y.set(e,n),n},clear:function(){y.clear()}}),k=(g=Math.floor(1e3/60),h={},m=0,"function"==typeof requestAnimationFrame&&"function"==typeof cancelAnimationFrame?(d=function(e){var n=Math.random();return h[n]=requestAnimationFrame(function t(o){m===o||m+g-1<o?(m=o,delete h[n],e()):h[n]=requestAnimationFrame(t)}),n},u=function(e){h[e]&&cancelAnimationFrame(h[e])}):(d=function(e){return setTimeout(e,g)},u=function(e){return clearTimeout(e)}),{frame:d,cancel:u}),R=(v={},function(){if(x)return x;if(!o&&r){var n=["var CONFETTI, SIZE = {}, module = {};","("+e.toString()+")(this, module, true, SIZE);","onmessage = function(msg) {","  if (msg.data.options) {","    CONFETTI(msg.data.options).then(function () {","      if (msg.data.callback) {","        postMessage({ callback: msg.data.callback });","      }","    });","  } else if (msg.data.reset) {","    CONFETTI && CONFETTI.reset();","  } else if (msg.data.resize) {","    SIZE.width = msg.data.resize.width;","    SIZE.height = msg.data.resize.height;","  } else if (msg.data.canvas) {","    SIZE.width = msg.data.canvas.width;","    SIZE.height = msg.data.canvas.height;","    CONFETTI = module.exports.create(msg.data.canvas);","  }","}"].join("\n");try{x=new Worker(URL.createObjectURL(new Blob([n])))}catch(e){return void 0!==typeof console&&"function"==typeof console.warn&&console.warn("üéä Could not load worker",e),null}!function(e){function n(n,t){e.postMessage({options:n||{},callback:t})}e.init=function(n){var t=n.transferControlToOffscreen();e.postMessage({canvas:t},[t])},e.fire=function(t,o,i){if(f)return n(t,null),f;var r=Math.random().toString(36).slice(2);return f=c(function(o){function s(n){n.data.callback===r&&(delete v[r],e.removeEventListener("message",s),f=null,w.clear(),i(),o())}e.addEventListener("message",s),n(t,r),v[r]=s.bind(null,{data:{callback:r}})})},e.reset=function(){for(var n in e.postMessage({reset:!0}),v)v[n](),delete v[n]}}(x)}return x}),S={particleCount:50,angle:90,spread:45,startVelocity:45,decay:.9,gravity:1,drift:0,ticks:200,x:.5,y:.5,shapes:["square","circle"],zIndex:100,colors:["#26ccff","#a25afd","#ff5e7e","#88ff5a","#fcff42","#ffa62d","#ff36ff"],disableForReducedMotion:!1,scalar:1};function M(e,n,t){return function(e,n){return n?n(e):e}(e&&null!=e[n]?e[n]:S[n],t)}function L(e){return e<0?0:Math.floor(e)}function E(e,n){return Math.floor(Math.random()*(n-e))+e}function C(e){return parseInt(e,16)}function T(e){return e.map(G)}function G(e){var n=String(e).replace(/[^0-9a-f]/gi,"");return n.length<6&&(n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2]),{r:C(n.substring(0,2)),g:C(n.substring(2,4)),b:C(n.substring(4,6))}}function I(e){e.width=document.documentElement.clientWidth,e.height=document.documentElement.clientHeight}function P(e){var n=e.getBoundingClientRect();e.width=n.width,e.height=n.height}function $(e){var n=e.angle*(Math.PI/180),t=e.spread*(Math.PI/180);return{x:e.x,y:e.y,wobble:10*Math.random(),wobbleSpeed:Math.min(.11,.1*Math.random()+.05),velocity:.5*e.startVelocity+Math.random()*e.startVelocity,angle2D:-n+(.5*t-Math.random()*t),tiltAngle:(.5*Math.random()+.25)*Math.PI,color:e.color,shape:e.shape,tick:0,totalTicks:e.ticks,decay:e.decay,drift:e.drift,random:Math.random()+2,tiltSin:0,tiltCos:0,wobbleX:0,wobbleY:0,gravity:3*e.gravity,ovalScalar:.6,scalar:e.scalar,flat:e.flat}}function A(e,t){var a,l=!e,p=!!M(t||{},"resize"),y=!1,d=M(t,"disableForReducedMotion",Boolean),u=r&&M(t||{},"useWorker")?R():null,g=l?I:P,h=!(!e||!u||!e.__confetti_initialized),m="function"==typeof matchMedia&&matchMedia("(prefers-reduced-motion)").matches;function x(n,t,r){for(var l=M(n,"particleCount",L),p=M(n,"angle",Number),y=M(n,"spread",Number),d=M(n,"startVelocity",Number),u=M(n,"decay",Number),h=M(n,"gravity",Number),m=M(n,"drift",Number),x=M(n,"colors",T),f=M(n,"ticks",Number),v=M(n,"shapes"),b=M(n,"scalar"),R=!!M(n,"flat"),S=function(e){var n=M(e,"origin",Object);return n.x=M(n,"x",Number),n.y=M(n,"y",Number),n}(n),C=l,G=[],I=e.width*S.x,P=e.height*S.y;C--;)G.push($({x:I,y:P,angle:p,spread:y,startVelocity:d,color:x[C%x.length],shape:v[E(0,v.length)],ticks:f,decay:u,gravity:h,drift:m,scalar:b,flat:R}));return a?a.addFettis(G):(a=function(e,n,t,r,a){var l,p,y=n.slice(),d=e.getContext("2d"),u=c(function(n){function c(){l=p=null,d.clearRect(0,0,r.width,r.height),w.clear(),a(),n()}l=k.frame(function n(){!o||r.width===i.width&&r.height===i.height||(r.width=e.width=i.width,r.height=e.height=i.height),r.width||r.height||(t(e),r.width=e.width,r.height=e.height),d.clearRect(0,0,r.width,r.height),(y=y.filter(function(e){return function(e,n){n.x+=Math.cos(n.angle2D)*n.velocity+n.drift,n.y+=Math.sin(n.angle2D)*n.velocity+n.gravity,n.velocity*=n.decay,n.flat?(n.wobble=0,n.wobbleX=n.x+10*n.scalar,n.wobbleY=n.y+10*n.scalar,n.tiltSin=0,n.tiltCos=0,n.random=1):(n.wobble+=n.wobbleSpeed,n.wobbleX=n.x+10*n.scalar*Math.cos(n.wobble),n.wobbleY=n.y+10*n.scalar*Math.sin(n.wobble),n.tiltAngle+=.1,n.tiltSin=Math.sin(n.tiltAngle),n.tiltCos=Math.cos(n.tiltAngle),n.random=Math.random()+2);var t=n.tick++/n.totalTicks,o=n.x+n.random*n.tiltCos,i=n.y+n.random*n.tiltSin,r=n.wobbleX+n.random*n.tiltCos,a=n.wobbleY+n.random*n.tiltSin;if(e.fillStyle="rgba("+n.color.r+", "+n.color.g+", "+n.color.b+", "+(1-t)+")",e.beginPath(),s&&"path"===n.shape.type&&"string"==typeof n.shape.path&&Array.isArray(n.shape.matrix))e.fill(function(e,n,t,o,i,r,s){var a=new Path2D(e),l=new Path2D;l.addPath(a,new DOMMatrix(n));var c=new Path2D;return c.addPath(l,new DOMMatrix([Math.cos(s)*i,Math.sin(s)*i,-Math.sin(s)*r,Math.cos(s)*r,t,o])),c}(n.shape.path,n.shape.matrix,n.x,n.y,.1*Math.abs(r-o),.1*Math.abs(a-i),Math.PI/10*n.wobble));else if("bitmap"===n.shape.type){var l=Math.PI/10*n.wobble,c=.1*Math.abs(r-o),p=.1*Math.abs(a-i),y=n.shape.bitmap.width*n.scalar,d=n.shape.bitmap.height*n.scalar,u=new DOMMatrix([Math.cos(l)*c,Math.sin(l)*c,-Math.sin(l)*p,Math.cos(l)*p,n.x,n.y]);u.multiplySelf(new DOMMatrix(n.shape.matrix));var g=e.createPattern(w.transform(n.shape.bitmap),"no-repeat");g.setTransform(u),e.globalAlpha=1-t,e.fillStyle=g,e.fillRect(n.x-y/2,n.y-d/2,y,d),e.globalAlpha=1}else if("circle"===n.shape)e.ellipse?e.ellipse(n.x,n.y,Math.abs(r-o)*n.ovalScalar,Math.abs(a-i)*n.ovalScalar,Math.PI/10*n.wobble,0,2*Math.PI):function(e,n,t,o,i,r,s,a){e.save(),e.translate(n,t),e.rotate(r),e.scale(o,i),e.arc(0,0,1,0,a,void 0),e.restore()}(e,n.x,n.y,Math.abs(r-o)*n.ovalScalar,Math.abs(a-i)*n.ovalScalar,Math.PI/10*n.wobble,0,2*Math.PI);else if("star"===n.shape)for(var h=Math.PI/2*3,m=4*n.scalar,x=8*n.scalar,f=n.x,v=n.y,b=5,k=Math.PI/b;b--;)f=n.x+Math.cos(h)*x,v=n.y+Math.sin(h)*x,e.lineTo(f,v),h+=k,f=n.x+Math.cos(h)*m,v=n.y+Math.sin(h)*m,e.lineTo(f,v),h+=k;else e.moveTo(Math.floor(n.x),Math.floor(n.y)),e.lineTo(Math.floor(n.wobbleX),Math.floor(i)),e.lineTo(Math.floor(r),Math.floor(a)),e.lineTo(Math.floor(o),Math.floor(n.wobbleY));return e.closePath(),e.fill(),n.tick<n.totalTicks}(d,e)})).length?l=k.frame(n):c()}),p=c});return{addFettis:function(e){return y=y.concat(e),u},canvas:e,promise:u,reset:function(){l&&k.cancel(l),p&&p()}}}(e,G,g,t,r),a.promise)}function f(t){var o=d||M(t,"disableForReducedMotion",Boolean),i=M(t,"zIndex",Number);if(o&&m)return c(function(e){e()});l&&a?e=a.canvas:l&&!e&&(e=function(e){var n=document.createElement("canvas");return n.style.position="fixed",n.style.top="0px",n.style.left="0px",n.style.pointerEvents="none",n.style.zIndex=e,n}(i),document.body.appendChild(e)),p&&!h&&g(e);var r={width:e.width,height:e.height};function s(){if(u){var n={getBoundingClientRect:function(){if(!l)return e.getBoundingClientRect()}};return g(n),void u.postMessage({resize:{width:n.width,height:n.height}})}r.width=r.height=null}function f(){a=null,p&&(y=!1,n.removeEventListener("resize",s)),l&&e&&(document.body.contains(e)&&document.body.removeChild(e),e=null,h=!1)}return u&&!h&&u.init(e),h=!0,u&&(e.__confetti_initialized=!0),p&&!y&&(y=!0,n.addEventListener("resize",s,!1)),u?u.fire(t,r,f):x(t,r,f)}return f.reset=function(){u&&u.reset(),a&&a.reset()},f}function q(){return b||(b=A(null,{useWorker:!0,resize:!0})),b}t.exports=function(){return q().apply(this,arguments)},t.exports.reset=function(){q().reset()},t.exports.create=A,t.exports.shapeFromPath=function(e){if(!s)throw new Error("path confetti are not supported in this browser");var n,t;"string"==typeof e?n=e:(n=e.path,t=e.matrix);var o=new Path2D(n),i=document.createElement("canvas").getContext("2d");if(!t){for(var r,a,l=1e3,c=l,p=l,y=0,d=0,u=0;u<l;u+=2)for(var g=0;g<l;g+=2)i.isPointInPath(o,u,g,"nonzero")&&(c=Math.min(c,u),p=Math.min(p,g),y=Math.max(y,u),d=Math.max(d,g));r=y-c,a=d-p;var h=Math.min(10/r,10/a);t=[h,0,0,h,-Math.round(r/2+c)*h,-Math.round(a/2+p)*h]}return{type:"path",path:n,matrix:t}},t.exports.shapeFromText=function(e){var n,t=1,o="#000000",i='"Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", "EmojiOne Color", "Android Emoji", "Twemoji Mozilla", "system emoji", sans-serif';"string"==typeof e?n=e:(n=e.text,t="scalar"in e?e.scalar:t,i="fontFamily"in e?e.fontFamily:i,o="color"in e?e.color:o);var r=10*t,s=r+"px "+i,a=new OffscreenCanvas(r,r),l=a.getContext("2d");l.font=s;var c=l.measureText(n),p=Math.ceil(c.actualBoundingBoxRight+c.actualBoundingBoxLeft),y=Math.ceil(c.actualBoundingBoxAscent+c.actualBoundingBoxDescent),d=c.actualBoundingBoxLeft+2,u=c.actualBoundingBoxAscent+2;p+=4,y+=4,(l=(a=new OffscreenCanvas(p,y)).getContext("2d")).font=s,l.fillStyle=o,l.fillText(n,d,u);var g=1/t;return{type:"bitmap",bitmap:a.transferToImageBitmap(),matrix:[g,0,0,g,-p*g/2,-y*g/2]}}}(function(){return"undefined"!=typeof window?window:"undefined"!=typeof self?self:this||{}}(),t,!1);const o=t.exports;t.exports.create,console.log("[ReplyGuy Content] Script loaded at:",(new Date).toISOString(),window.location.href);let i=null,r={isAuthenticated:!1};chrome.runtime.onMessage.addListener((e,t,s)=>{"authStateChanged"===e.action?(r=e.data,console.log("[ReplyGuy Content] Auth state changed:",r),i&&i.cleanup(),i=new n,i.initialize()):"triggerCelebration"===e.action&&function(){const e={origin:{y:.7},zIndex:9999};function n(n,t){o({...e,...t,particleCount:Math.floor(200*n)})}n(.25,{spread:26,startVelocity:55}),n(.2,{spread:60}),n(.35,{spread:100,decay:.91,scalar:.8}),n(.1,{spread:120,startVelocity:25,decay:.92,scalar:1.2}),n(.1,{spread:120,startVelocity:45})}()});let s=location.href;new MutationObserver(()=>{const e=location.href;e!==s&&(s=e,i&&i.handleUrlChange())}).observe(document,{subtree:!0,childList:!0}),async function(){console.log("[ReplyGuy Content] Initializing on:",window.location.href);try{console.log("[ReplyGuy Content] Checking authentication...");const e=await chrome.runtime.sendMessage({action:"checkAuth"});console.log("[ReplyGuy Content] Auth response:",e),e.success&&(r=e.data,console.log("[ReplyGuy Content] Auth state:",r)),console.log("[ReplyGuy Content] Initializing Twitter integration"),i=new n,i.initialize()}catch(e){console.error("[ReplyGuy Content] Initialization error:",e)}}()})();